const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0"; // Smart Cushion Service
const SIT_TIME_UUID = "12345678-1234-5678-1234-56789abcdef1";
const STAND_TIME_UUID = "12345678-1234-5678-1234-56789abcdef2";

async function connectToBLE() {
    try {
        console.log("Requesting Bluetooth Device...");
        let device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [SERVICE_UUID]  // Теперь правильный сервис
        });

        console.log("Connecting to GATT Server...");
        let server = await device.gatt.connect();

        console.log("Getting Smart Cushion Service...");
        let service = await server.getPrimaryService(SERVICE_UUID);

        console.log("Getting Characteristics...");
        let sitTimeCharacteristic = await service.getCharacteristic(SIT_TIME_UUID);
        let standTimeCharacteristic = await service.getCharacteristic(STAND_TIME_UUID);

        document.getElementById("status").innerText = "Connected ✅";

        // Подписываемся на обновления
        sitTimeCharacteristic.addEventListener("characteristicvaluechanged", handleSitTime);
        standTimeCharacteristic.addEventListener("characteristicvaluechanged", handleStandTime);

        await sitTimeCharacteristic.startNotifications();
        await standTimeCharacteristic.startNotifications();

        console.log("Listening for SitTime and StandTime updates...");
    } catch (error) {
        console.log("Error: ", error);
        document.getElementById("status").innerText = "Failed to connect ❌";
    }
}

function handleSitTime(event) {
    let value = new DataView(event.target.value.buffer).getUint32(0, true);
    document.getElementById("sitTime").innerText = value;
}

function handleStandTime(event) {
    let value = new DataView(event.target.value.buffer).getUint32(0, true);
    document.getElementById("standTime").innerText = value;
}